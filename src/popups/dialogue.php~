<?php

require '../security.php';
require '../classes/class_external_script.php';

require '../classes/class_npc_manager.php';

class DialoguePage extends EXTERNAL_SCRIPT
{
	private $questMgr = null;


	function DisplayBody() {
          $pid = playerManager::getInstance()->getPlayer()->id;
	  $dialogueid = playerManager::getInstance()->getPlayer()->dialogue;

          $query = 'SELECT dialogue_position FROM dialogues_players WHERE player_id = ? AND dialogue = ?';

	  $stmt = MySQLConnection::getInstance()->prepare($query);
	  $stmt->bind_param('ii', $pid, $dialogueid);
	  $stmt->execute();


	  echo $pid.' '.$dialogueid;

	  $stmt->store_result();
          $stmt->bind_result($position);
	  $stmt->fetch();
	
	  echo $position;
	









	}

  private function beginDialogue($npcid) {
    $npc = $this->npcMgr->getNPC($npcid);

    $player = playerManager::getInstance()->getPlayer();
    $player->dialogue = $npc->dialogue;
    echo 'dialogue: '.$npc->dialogue;
    $player->save();


    $query = 'INSERT INTO dialogues_players (player_id, dialogue, dialogue_position) VALUES (?,?,?)';
    $stmt = MySQLConnection::getInstance()->prepare($query);

    $pid = $player->id;
    $dialogue = $npc->dialogue;
    $position = 1;

    $stmt->bind_param('iii',$pid,$dialogue,$position);

    $stmt->execute();




  }

	function __construct() {
		session_start();
		$this->npcMgr = new NPCManager;

                switch($_GET['action']) {
                  case 'begin': $this->beginDialogue($_GET['npc']);
                }


		$this->Display('external_script.css','Questy');


	}

}

	// vytvorenie objektu skriptu
	$page = new DialoguePage();

?>